<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Juicy Vending Machine</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg1: #0f2027;
            --bg2: #203a43;
            --bg3: #2c5364;
            --accent: #ffd166;
            --accent-2: #ff9f1c;
            --muted: rgba(255,255,255,0.18);
            --glass: rgba(255,255,255,0.06);
            --card: rgba(255,255,255,0.08);
            --text: #eef6f9;
        }

        /* animated gradient background */
        html,body{height:100%;}
        body {
            margin: 0;
            font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            color: var(--text);
            background: linear-gradient(120deg,var(--bg1), var(--bg2), var(--bg3));
            background-size: 400% 400%;
            animation: bgShift 18s ease infinite;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            flex-direction:column;
            align-items:center;
            min-height:100vh;
            gap:20px;
            padding:26px;
        }

        @keyframes bgShift {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        h1 {
            margin: 10px 0 0 0;
            font-size: clamp(1.6rem, 3vw, 2.6rem);
            font-weight:800;
            letter-spacing:1px;
            text-align:center;
            text-shadow: 0 6px 30px rgba(0,0,0,0.45);
        }

        .vending-machine {
            /* larger, more prominent vending machine with subtle frosted glass */
            width: min(1180px, 98%);
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
            backdrop-filter: blur(6px) saturate(1.05);
            -webkit-backdrop-filter: blur(6px) saturate(1.05);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 18px 60px rgba(2,8,23,0.65), inset 0 1px 0 rgba(255,255,255,0.02);
            display: grid;
            grid-template-columns: 420px 1fr; /* wider left panel */
            gap: 20px;
            align-items:start;
            position:relative;
            overflow: hidden;
        }

        /* decorative floating fruits in background */
        .floating {
            position:absolute;
            inset:0;
            pointer-events:none;
        }
        .fruit {
            position:absolute;
            font-size:40px;
            opacity:0.12;
            animation: floaty 8s ease-in-out infinite;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5));
        }
        .fruit.f1{left:6%; top:10%; transform:scale(1.2); animation-delay: -2s;}
        .fruit.f2{right:6%; top:18%; transform:scale(1.35); animation-delay: -4s;}
        .fruit.f3{left:18%; bottom:12%; transform:scale(1.05); animation-delay: -1s;}
        .fruit.f4{right:20%; bottom:18%; transform:scale(1.15); animation-delay: -3s;}
        @keyframes floaty {
            0%{transform: translateY(0) rotate(0deg) scale(1)}
            50%{transform: translateY(-18px) rotate(6deg) scale(1.02)}
            100%{transform: translateY(0) rotate(0deg) scale(1)}
        }

        /* Pac-Man & Ghost canvas layer (pixel-art ghosts will be drawn on this) */
        .floating { position: absolute; inset: 0; pointer-events: none; overflow: visible; }
        .pac-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            image-rendering: pixelated;
        }

        /* (ghost DOM/CSS removed) ghosts are drawn as pixel sprites on the pacCanvas */

        /* small path dots */
        .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.18);
            top: 50%;
            left: 30%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.45);
            animation: dotPulse 1.6s ease-in-out infinite;
        }
        @keyframes dotPulse { 0%{opacity:1} 50%{opacity:0.35} 100%{opacity:1} }

        /* left column: machine + coin input */
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 12px;
            padding: 18px;
            min-height: 260px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
        }

        .machine-top {
            display:flex;
            align-items:center;
            gap:12px;
            margin-bottom:12px;
        }

        .logo {
            width:76px;
            height:76px;
            border-radius:12px;
            display:grid;
            place-items:center;
            font-size:36px;
            font-weight:800;
            color: #053742;
            background: linear-gradient(180deg,var(--accent), var(--accent-2));
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
        }

        .tagline {
            font-weight:600;
            font-size:1.05rem;
            color:var(--text);
        }

        .insert-coins {
            margin-top: 6px;
            margin-bottom:10px;
            background: var(--glass);
            padding:12px;
            border-radius:10px;
        }

        .coin-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
        .coin-input {
            font-size:1rem;
            padding:10px;
            border-radius:8px;
            border: none;
            width:140px;
            background: rgba(255,255,255,0.03);
            color:var(--text);
        }
        .coin-input::-webkit-inner-spin-button { opacity: 0.6; }

        .coin-btn {
            padding:10px 12px;
            background: linear-gradient(180deg,var(--accent), var(--accent-2));
            border: none;
            border-radius:8px;
            font-weight:700;
            color:#053742;
            cursor:pointer;
            box-shadow: 0 8px 22px rgba(0,0,0,0.4);
        }
        .coin-btn.secondary {
            background: transparent;
            border:1px solid rgba(255,255,255,0.06);
            color:var(--text);
            box-shadow:none;
        }

        .quick-buttons{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;}
        .quick {
            background: rgba(255,255,255,0.03);
            border:none;
            padding:8px 10px;
            border-radius:8px;
            color:var(--text);
            cursor:pointer;
            font-weight:600;
        }

        .balance {
            margin-top:12px;
            font-weight:700;
            color: var(--text);
            font-size:1.05rem;
        }

        /* right column: juice grid + display */
        .right {
            padding: 10px 6px;
            display:flex;
            flex-direction:column;
            gap:12px;
        }

        .juice-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap:12px;
            align-items:stretch;
        }

        .juice-button {
            display:flex;
            align-items:center;
            gap:14px;
            padding:16px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border-radius:12px;
            border:1px solid rgba(255,255,255,0.04);
            color:var(--text);
            cursor:pointer;
            transition: transform .18s ease, box-shadow .18s ease, background .18s;
            box-shadow: 0 8px 18px rgba(2,8,23,0.5);
        }
        .juice-button:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(2,8,23,0.6);
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        }
        .juice-icon {
            font-size:34px;
            width:56px;
            height:56px;
            display:grid;
            place-items:center;
            border-radius:10px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            box-shadow: 0 6px 18px rgba(0,0,0,0.35) inset;
        }
        .juice-title {font-weight:700; font-size:0.98rem;}
        /* fix layout: let the middle text column shrink and keep price out of the icon */
        .juice-button > div:nth-child(2) {
            flex: 1 1 auto;   /* take remaining space */
            min-width: 0;     /* allow flex children to shrink properly */
            overflow: hidden; /* avoid overflowing into neighbors */
        }
        .juice-title {
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .price {
            flex: 0 0 auto;   /* do not let price shrink — stays at right */
            margin-left: 12px; /* small spacing instead of auto if needed */
        }

        .display {
            margin-top: 2px;
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02));
            font-size: 1rem;
            min-height:70px;
            display:flex;
            gap:8px;
            align-items:center;
            justify-content:space-between;
        }

        .freshness {
            font-weight:800;
            color: #b7f1dd;
            background: rgba(0,0,0,0.12);
            padding:6px 10px;
            border-radius:10px;
            border: 1px solid rgba(183,241,221,0.08);
        }

        footer {
            width:min(980px,95%);
            text-align:center;
            color: rgba(255,255,255,0.7);
            font-size:0.95rem;
            padding:8px 12px;
            border-radius:12px;
            background: transparent;
        }

        /* animated background canvas behind everything */
        .bg-canvas {
             position: fixed;
             inset: 0;
             width: 100%;
             height: 100%;
             z-index: 0;
             pointer-events: none;
             mix-blend-mode: screen;
             opacity: 0.55; /* tone down background so vending machine reads as foreground */
        }

        /* ensure main content sits above the canvas */
        .vending-machine {
            position: relative;
            z-index: 2;
        }

        /* responsive */
        @media (max-width:880px){
            .vending-machine{grid-template-columns: 1fr; padding:14px;}
            .panel{order:2;}
            .right{order:1;}
            .fruit{display:none;}
        }
    </style>
</head>
<body>
    <h1>🥤 Juicy Vending Machine</h1>
 
    <div class="vending-machine" role="application" aria-label="Juice vending machine UI">
        <div class="floating" aria-hidden="true">
            <!-- Pac‑Men and ghosts will be drawn into this canvas for a classic, crisp look -->
            <canvas id="pacCanvas" class="pac-canvas" aria-hidden="true"></canvas>
             <!-- decorative dots -->
             <div class="dot" style="left:20%; top:40%; animation-delay:0s"></div>
            <div class="dot" style="left:35%; top:30%; animation-delay:0.2s"></div>
            <div class="dot" style="left:55%; top:22%; animation-delay:0.4s"></div>
            <div class="dot" style="left:72%; top:36%; animation-delay:0.6s"></div>
            <div class="dot" style="left:48%; top:52%; animation-delay:0.8s"></div>
        </div>

        <!-- LEFT PANEL -->
        <div class="panel">
            <div class="machine-top">
                <div class="logo">JV</div>
                <div>
                    <div class="tagline">Fresh. Cool. Juicy.</div>
                    <div style="font-size:0.85rem; color:rgba(255,255,255,0.6)">Tap a fruit, insert coins & enjoy.</div>
                </div>
            </div>

            <div class="insert-coins" aria-label="Insert coins area">
                <div style="font-weight:700; margin-bottom:8px">Insert Coins (NT$)</div>
                <div class="coin-row">
                    <input id="coinInput" class="coin-input" type="number" min="1" step="1" placeholder="Amount" />
                    <button class="coin-btn" onclick="insertCoins()">Add</button>
                    <button class="coin-btn secondary" onclick="refund()">Refund</button>
                </div>

                <div class="quick-buttons" aria-hidden="false">
                    <button class="quick" onclick="quickAdd(10)">+NT$10</button>
                    <button class="quick" onclick="quickAdd(20)">+NT$20</button>
                    <button class="quick" onclick="quickAdd(50)">+NT$50</button>
                    <button class="quick" onclick="quickAdd(100)">+NT$100</button>
                </div>

                <div class="balance" id="balanceDisplay">Current Balance: NT$ 0</div>
            </div>

            <div style="margin-top:12px; font-size:0.95rem; color:rgba(255,255,255,0.8)">
                Tip: buy multiple juices — balance carries over. Use Refund to get remaining coins.
            </div>
        </div>

        <!-- RIGHT: JUICES + DISPLAY -->
        <div class="right">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:800; font-size:1.05rem">Choose your juice</div>
                <div style="font-size:0.9rem; color:rgba(255,255,255,0.7)">Prices in NT$</div>
            </div>

            <div class="juice-grid" id="juiceGrid">
                <button class="juice-button" onclick="selectJuice('Apple Juice', 10, '🍎')">
                    <div class="juice-icon">🍎</div>
                    <div>
                        <div class="juice-title">Apple</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Crisp & fresh</div>
                    </div>
                    <div class="price">NT$10</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Orange Juice', 10, '🍊')">
                    <div class="juice-icon">🍊</div>
                    <div>
                        <div class="juice-title">Orange</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Sun-kissed</div>
                    </div>
                    <div class="price">NT$10</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Strawberry Juice', 15, '🍓')">
                    <div class="juice-icon">🍓</div>
                    <div>
                        <div class="juice-title">Strawberry</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Sweet & bright</div>
                    </div>
                    <div class="price">NT$15</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Pineapple Juice', 10, '🍍')">
                    <div class="juice-icon">🍍</div>
                    <div>
                        <div class="juice-title">Pineapple</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Tropical zing</div>
                    </div>
                    <div class="price">NT$10</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Grape Juice', 15, '🍇')">
                    <div class="juice-icon">🍇</div>
                    <div>
                        <div class="juice-title">Grape</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Juicy bunch</div>
                    </div>
                    <div class="price">NT$15</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Mango Juice', 20, '🥭')">
                    <div class="juice-icon">🥭</div>
                    <div>
                        <div class="juice-title">Mango</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Creamy tropical</div>
                    </div>
                    <div class="price">NT$20</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Watermelon Juice', 12, '🍉')">
                    <div class="juice-icon">🍉</div>
                    <div>
                        <div class="juice-title">Watermelon</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Cool & hydrating</div>
                    </div>
                    <div class="price">NT$12</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Kiwi Juice', 18, '🥝')">
                    <div class="juice-icon">🥝</div>
                    <div>
                        <div class="juice-title">Kiwi</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Tangy green</div>
                    </div>
                    <div class="price">NT$18</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Coconut Juice', 15, '🥥')">
                    <div class="juice-icon">🥥</div>
                    <div>
                        <div class="juice-title">Coconut</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Island vibes</div>
                    </div>
                    <div class="price">NT$15</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Lemon Juice', 8, '🍋')">
                    <div class="juice-icon">🍋</div>
                    <div>
                        <div class="juice-title">Lemon</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Zesty & bright</div>
                    </div>
                    <div class="price">NT$8</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Mixed Berry Juice', 22, '🫐')">
                    <div class="juice-icon">🫐</div>
                    <div>
                        <div class="juice-title">Mixed Berry</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Berry blast</div>
                    </div>
                    <div class="price">NT$22</div>
                </button>

                <button class="juice-button" onclick="selectJuice('Peach Juice', 16, '🍑')">
                    <div class="juice-icon">🍑</div>
                    <div>
                        <div class="juice-title">Peach</div>
                        <div style="font-size:0.78rem; color:rgba(255,255,255,0.55)">Soft & sweet</div>
                    </div>
                    <div class="price">NT$16</div>
                </button>
            </div>

            <div class="display" id="display" role="status" aria-live="polite">
                <div id="displayText">Make your selection!</div>
                <div style="display:flex; gap:8px; align-items:center">
                    <div class="freshness" id="freshness">Freshness: --%</div>
                    <div style="font-size:0.9rem; color:rgba(255,255,255,0.7)">Balance: <strong id="miniBalance">NT$0</strong></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        Created with real juice & freshness. UI designed for delight.
    </footer>

    <!-- dynamic soft-particle background -->
    <canvas id="bgCanvas" class="bg-canvas" aria-hidden="true"></canvas>

    <script>
    // Pause animations when the tab is hidden to save CPU
    (function(){
        window.__ANIMATIONS_ENABLED__ = true;
        document.addEventListener('visibilitychange', () => {
            window.__ANIMATIONS_ENABLED__ = document.visibilityState === 'visible';
        }, { passive: true });
    })();

    // In your canvas/step loops, check window.__ANIMATIONS_ENABLED__ before doing heavy work:
    // Example (inside draw/step):
    // if (!window.__ANIMATIONS_ENABLED__) { last = performance.now(); requestAnimationFrame(draw); return; }

    /* ====== Soft background particle canvas (drifting blobs / orbs) ======
       - lightweight canvas particles that drift slowly behind the UI
       - uses delta-time, responsive to resize, uses radial gradients
    */
    (function(){
        const canvas = document.getElementById('bgCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d', { alpha: true });
        let DPR = Math.max(1, window.devicePixelRatio || 1);
        let w = 0, h = 0;

        function resize(){
            DPR = Math.max(1, window.devicePixelRatio || 1);
            w = window.innerWidth;
            h = window.innerHeight;
            canvas.width = Math.round(w * DPR);
            canvas.height = Math.round(h * DPR);
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            ctx.setTransform(DPR,0,0,DPR,0,0);
        }
        window.addEventListener('resize', resize, { passive: true });
        resize();

        // particle pool
        const COUNT = Math.max(24, Math.round((w*h) / (1200*1200) * 60)); // scale with screen
        const colors = [
            'rgba(255, 220, 120,', // warm
            'rgba(160, 230, 210,', // teal
            'rgba(200, 220, 255,', // cool
        ];
        const particles = [];
        for (let i=0;i<COUNT;i++){
            particles.push({
                x: Math.random()*w,
                y: Math.random()*h,
                r: Math.random()*60 + 18,
                vx: (Math.random()-0.5) * 30, // px/sec
                vy: (Math.random()-0.5) * 20,
                hue: colors[Math.floor(Math.random()*colors.length)],
                driftPhase: Math.random()*Math.PI*2,
                alpha: 0.06 + Math.random()*0.12
            });
        }

        let last = performance.now();
        function draw(now){
            const dt = Math.min(0.05, (now - last)/1000);
            last = now;
            // clear with a very subtle darken to keep trails soft
            ctx.clearRect(0,0,w,h);

            for (let p of particles){
                // gentle sinusoidal drift for organic motion
                p.driftPhase += dt * (0.4 + Math.abs(p.vx+p.vy)*0.001);
                p.x += p.vx * dt + Math.sin(p.driftPhase) * 6 * dt;
                p.y += p.vy * dt + Math.cos(p.driftPhase*0.7) * 4 * dt;

                // wrap around edges for continuous coverage
                if (p.x < -p.r) p.x = w + p.r;
                if (p.x > w + p.r) p.x = -p.r;
                if (p.y < -p.r) p.y = h + p.r;
                if (p.y > h + p.r) p.y = -p.r;

                // draw soft radial blob
                const grd = ctx.createRadialGradient(p.x, p.y, p.r*0.05, p.x, p.y, p.r);
                grd.addColorStop(0, p.hue + (p.alpha * 1) + ')');
                grd.addColorStop(0.35, p.hue + (p.alpha * 0.6) + ')');
                grd.addColorStop(1, p.hue + '0)');
                ctx.beginPath();
                ctx.fillStyle = grd;
                ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                ctx.fill();
            }
            requestAnimationFrame(draw);
        }
        requestAnimationFrame(draw);
    })();

        // state
        let currentBalance = 0;

        function updateBalanceDisplays(){
            document.getElementById('balanceDisplay').innerText = `Current Balance: NT$ ${currentBalance}`;
            document.getElementById('miniBalance').innerText = `NT$ ${currentBalance}`;
        }

        function quickAdd(amount){
            currentBalance += Number(amount);
            updateBalanceDisplays();
            flashDisplay(`Added NT$ ${amount}`);
        }

        function insertCoins(){
            const v = Number(document.getElementById('coinInput').value || 0);
            if (!v || v <= 0){
                flashDisplay('Please enter a valid amount to add.');
                return;
            }
            currentBalance += v;
            document.getElementById('coinInput').value = '';
            updateBalanceDisplays();
            flashDisplay(`Inserted NT$ ${v}`);
        }

        function refund(){
            if (currentBalance <= 0){
                flashDisplay('No balance to refund.');
                return;
            }
            const refunded = currentBalance;
            currentBalance = 0;
            updateBalanceDisplays();
            flashDisplay(`Refunded NT$ ${refunded}`);
        }

        function selectJuice(name, price, emoji){
            if (currentBalance < price){
                flashDisplay(`Insufficient funds for ${name}. Need NT$ ${price}.`);
                pulseFreshness('--');
                return;
            }
            currentBalance -= price; // keep leftover for more purchases
            updateBalanceDisplays();

            const freshnessVal = Math.floor(75 + Math.random()*25); // 75-99%
            document.getElementById('freshness').innerText = `Freshness: ${freshnessVal}%`;
            document.getElementById('displayText').innerText = `Enjoy your ${name} ${emoji} — paid NT$${price}. Enjoy!`;
            // small celebratory animation
            celebrate(emoji);
        }

        function flashDisplay(text){
            const el = document.getElementById('displayText');
            el.innerText = text;
            // clear freshness hint
            pulseFreshness('--');
        }

        function pulseFreshness(val){
            document.getElementById('freshness').innerText = `Freshness: ${val}%`;
        }

        function celebrate(emoji){
            // quick floating emoji effect near display
            const el = document.createElement('div');
            el.style.position='fixed';
            el.style.left = (window.innerWidth/2 + (Math.random()*200-100)) + 'px';
            el.style.top = (window.innerHeight/2 + (Math.random()*120-60)) + 'px';
            el.style.fontSize='32px';
            el.style.opacity='0';
            el.style.transform='translateY(0)';
            el.style.transition='transform 900ms ease, opacity 900ms ease';
            el.innerText = emoji;
            document.body.appendChild(el);
            requestAnimationFrame(()=> {
                el.style.opacity='1';
                el.style.transform='translateY(-80px) rotate(8deg)';
            });
            setTimeout(()=> el.style.opacity='0', 700);
            setTimeout(()=> el.remove(), 1200);
        }

        /* Pac-Men + Ghosts movers updated:
           - Pac-Men are drawn into a dedicated canvas for a classic, crisp look matching the provided image
           - Ghosts remain DOM elements and are still moved by JS
        */
        (function(){
            const floating = document.querySelector('.floating');
            const container = document.querySelector('.vending-machine');
            if (!floating || !container) return;
            const pacCanvas = document.getElementById('pacCanvas');
            if (!pacCanvas) return;
            const ctx = pacCanvas.getContext('2d');
            const rand = (a,b) => Math.random()*(b-a)+a;

            // resize pac canvas to vending-machine pixel area
            function resizePacCanvas(){
                const r = container.getBoundingClientRect();
                const DPR = Math.max(1, window.devicePixelRatio || 1);
                pacCanvas.width  = Math.round(r.width * DPR);
                pacCanvas.height = Math.round(r.height * DPR);
                pacCanvas.style.width  = r.width + 'px';
                pacCanvas.style.height = r.height + 'px';
                ctx.setTransform(DPR,0,0,DPR, -r.left, -r.top); // draw in page coords
            }
            window.addEventListener('resize', resizePacCanvas, { passive: true });
            resizePacCanvas();

            // Pac state (pixel coords relative to container)
            const pacs = [];
            const PAC_COUNT = 6;
            for (let i=0;i<PAC_COUNT;i++){
                pacs.push({
                    x: rand(30, container.clientWidth-30),
                    y: rand(30, container.clientHeight-30),
                    vx: rand(-140,140),
                    vy: rand(-140,140),
                    mouthPhase: Math.random()*Math.PI*2,
                    turnCooldown: rand(0.6,2.4)
                });
            }

            // Ghosts will be drawn as pixel sprites on the pacCanvas (colors match your reference)
            const ghostColors = ['#ff2b2b','#ff9a2b','#3fe3e3','#ff9ad6']; // red, orange, cyan, pink
            const ghosts = [];
            const GHOST_COUNT = 4;
            for (let i=0;i<GHOST_COUNT;i++){
                ghosts.push({
                    x: rand(60, container.clientWidth-60),
                    y: rand(60, container.clientHeight-60),
                    vx: rand(-80,80),
                    vy: rand(-80,80),
                    turnCooldown: rand(0.8,3.2),
                    color: ghostColors[i % ghostColors.length]
                });
            }

            // draw a classic Pac-Man (filled wedge with thick black outline + eye) at (x,y)
            function drawPac(ctx, x, y, radius, angleRad, mouthOpen){
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angleRad);
                // mouth wedge: center facing to the right (0 rad)
                const mouth = mouthOpen ? 0.45 : 0.18; // radians
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.arc(0, 0, radius, mouth, Math.PI*2 - mouth);
                ctx.closePath();
                // fill
                ctx.fillStyle = '#ffd43b';
                ctx.fill();
                // outline - thicker to mimic pixel-art black border
                ctx.lineWidth = Math.max(2, radius * 0.14);
                ctx.strokeStyle = '#000';
                ctx.stroke();
                // eye (positioned relative to unrotated pac)
                ctx.beginPath();
                const ex = radius * 0.25;
                const ey = -radius * 0.28;
                ctx.arc(ex, ey, Math.max(1.6, radius*0.12), 0, Math.PI*2);
                ctx.fillStyle = '#000';
                ctx.fill();
                ctx.restore();
            }

            let last = performance.now();
            function step(now){
                if (!window.__ANIMATIONS_ENABLED__) { last = now; requestAnimationFrame(step); return; }
                const dt = Math.min(0.05, (now - last)/1000);
                last = now;
                const rect = container.getBoundingClientRect();

                // move pacs
                for (let s of pacs){
                    s.x += s.vx * dt;
                    s.y += s.vy * dt;
                    // bounce
                    const inset = 24;
                    if (s.x < inset){ s.x = inset; s.vx = Math.abs(s.vx); }
                    if (s.x > rect.width - inset){ s.x = rect.width - inset; s.vx = -Math.abs(s.vx); }
                    if (s.y < inset){ s.y = inset; s.vy = Math.abs(s.vy); }
                    if (s.y > rect.height - inset){ s.y = rect.height - inset; s.vy = -Math.abs(s.vy); }
                    // random turns
                    s.turnCooldown -= dt;
                    if (s.turnCooldown <= 0){
                        const ang = Math.atan2(s.vy, s.vx);
                        const delta = rand(-Math.PI*0.9, Math.PI*0.9);
                        const speed = Math.max(60, Math.hypot(s.vx, s.vy));
                        const newAng = ang + delta;
                        s.vx = Math.cos(newAng) * speed * rand(0.7,1.1);
                        s.vy = Math.sin(newAng) * speed * rand(0.7,1.1);
                        s.turnCooldown = rand(0.6, 2.8);
                    }
                    s.mouthPhase += dt * 12;
                }

                // move ghosts (update positions only; drawing happens below)
                for (let g of ghosts){
                    g.x += g.vx * dt;
                    g.y += g.vy * dt;
                    const inset = 30;
                    if (g.x < inset){ g.x = inset; g.vx = Math.abs(g.vx); }
                    if (g.x > rect.width - inset){ g.x = rect.width - inset; g.vx = -Math.abs(g.vx); }
                    if (g.y < inset){ g.y = inset; g.vy = Math.abs(g.vy); }
                    if (g.y > rect.height - inset){ g.y = rect.height - inset; g.vy = -Math.abs(g.vy); }
                    g.turnCooldown -= dt;
                    if (g.turnCooldown <= 0){
                        const ang = Math.atan2(g.vy, g.vx);
                        const delta = rand(-Math.PI*0.6, Math.PI*0.6);
                        const speed = Math.max(30, Math.hypot(g.vx, g.vy));
                        const newAng = ang + delta;
                        g.vx = Math.cos(newAng) * speed * rand(0.6,1.0);
                        g.vy = Math.sin(newAng) * speed * rand(0.6,1.0);
                        g.turnCooldown = rand(0.8, 3.0);
                    }
                }

                // clear pac canvas (only the vending-machine area)
                ctx.clearRect(rect.left, rect.top, rect.width, rect.height);
                // draw ghosts (pixel-art) behind pacs
                const ghostScale = 6; // pixel size per ghost block
                function drawGhost(ctx, x, y, scale, color){
                    // simple 7x6 pixel pattern approximating classic ghosts
                    const pattern = [
                        [0,1,1,1,1,1,0],
                        [1,1,1,1,1,1,1],
                        [1,1,1,1,1,1,1],
                        [1,1,1,1,1,1,1],
                        [1,1,1,1,1,1,1],
                        [1,0,1,0,1,0,1],
                    ];
                    ctx.save();
                    ctx.translate(x, y);
                    for (let ry=0; ry<pattern.length; ry++){
                        for (let rx=0; rx<pattern[0].length; rx++){
                            if (pattern[ry][rx]){
                                ctx.fillStyle = color;
                                ctx.fillRect((rx-3.5)*scale, (ry-3)*scale, scale, scale);
                            }
                        }
                    }
                    // eyes
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(-1*scale, -2*scale, scale, scale);
                    ctx.fillRect(1*scale, -2*scale, scale, scale);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(-0.6*scale, -1.6*scale, 0.6*scale, 0.6*scale);
                    ctx.fillRect(1.4*scale, -1.6*scale, 0.6*scale, 0.6*scale);
                    ctx.restore();
                }
                for (let g of ghosts){
                    drawGhost(ctx, rect.left + g.x, rect.top + g.y, ghostScale, g.color);
                }
                // draw pacs (map container local coords to global page coords) on top
                for (let s of pacs){
                    const ang = Math.atan2(s.vy, s.vx);
                    const mouthOpen = (Math.sin(s.mouthPhase) > 0.0);
                    drawPac(ctx, rect.left + s.x, rect.top + s.y, 18, ang, mouthOpen);
                }

                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        })();

        // init
        updateBalanceDisplays();
     </script>
 </body>
 </html>
